{"version":3,"sources":["../src/ctrl.js"],"names":["MetricsPanelCtrl","_","kbn","TimeSeries","d3","panelDefaults","legend","show","links","datasource","maxDataPoints","interval","targets","cacheTimeout","nullPointMode","aliasColors","format","valueName","strokeWidth","fontSize","width","height","GroupedBarChartCtrl","$scope","$injector","$rootScope","hiddenSeries","data","defaults","panel","events","on","onInitEditMode","bind","onDataReceived","onDataError","addEditorTab","unitFormats","getUnitFormats","subItem","value","render","series","color","alias","dataList","o","groupBy","rows","e","forOwn","i","t","sta","sum","tid","map","s","reduce","x","y","res","label","push","sort","a","b","decimalInfo","getDecimalsForValue","formatFunc","valueFormats","decimals","scaledDecimals","scope","elem","attrs","ctrl","groupedBarChart","opts","margin","showLegend","element","find","console","log","options","keys","filter","key","avgList","forEach","d","valores","name","length","draw","select","html","svg","append","attr","top","createScales","addAxes","addTooltips","addBar","addLegend","y0","scale","ordinal","rangeRoundBands","y1","linear","range","category20","xAxis","axis","tickSize","orient","yAxis","domain","rangeBand","max","left","call","style","bar","selectAll","enter","barC","text","tips","elements","elementData","__data__","display","slice","newData","onRender","sample","Chart","bottom","right","templateUrl"],"mappings":"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","file":"ctrl.js","sourcesContent":["import {MetricsPanelCtrl} from 'app/plugins/sdk';\r\nimport _ from 'lodash';\r\nimport kbn from 'app/core/utils/kbn';\r\nimport TimeSeries from 'app/core/time_series';\r\nimport * as d3 from './external/d3.v3.min';\r\nimport './css/groupedBarChart.css!';\r\n// import groupedBarChart from './external/groupedBarChart';\r\n\r\nconst panelDefaults = {\r\n    legend: {\r\n        show: true\r\n    },\r\n    links: [],\r\n    datasource: null,\r\n    maxDataPoints: 3,\r\n    interval: null,\r\n    targets: [{}],\r\n    cacheTimeout: null,\r\n    nullPointMode: 'connected',\r\n    aliasColors: {},\r\n    format: 'short',\r\n    valueName: 'current',\r\n    strokeWidth: 1,\r\n    fontSize: '80%',\r\n    width: 800,\r\n    height: 400\r\n};\r\n\r\nexport class GroupedBarChartCtrl extends MetricsPanelCtrl {\r\n\r\n    constructor($scope, $injector, $rootScope) {\r\n        super($scope, $injector);\r\n        this.$rootScope = $rootScope;\r\n        this.hiddenSeries = {};\r\n        this.data = null;\r\n\r\n        _.defaults(this.panel, panelDefaults);\r\n\r\n        this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\r\n        this.events.on('data-received', this.onDataReceived.bind(this));\r\n        this.events.on('data-snapshot-load', this.onDataReceived.bind(this));\r\n        this.events.on('data-error', this.onDataError.bind(this));\r\n    }\r\n\r\n    onInitEditMode() {\r\n        this.addEditorTab('Options', 'public/plugins/grafana-groupedbarchart-panel/partials/editor.html', 2);\r\n        this.unitFormats = kbn.getUnitFormats();\r\n    }\r\n\r\n    setUnitFormat(subItem) {\r\n        this.panel.format = subItem.value;\r\n        this.render();\r\n    }\r\n\r\n    onDataError() {\r\n        this.series = [];\r\n        this.render();\r\n    }\r\n\r\n    changeSeriesColor(series, color) {\r\n        series.color = color;\r\n        this.panel.aliasColors[series.alias] = series.color;\r\n        this.render();\r\n    }\r\n\r\n    onDataReceived(dataList) {\r\n\r\n        let o = _.groupBy(dataList[0].rows, e=>e[0]);\r\n        _.forOwn(o, (e, i)=>{\r\n            let t = _.groupBy(e, sta=>sta[1]);\r\n            o[i] = _.forOwn(t, (sum, tid)=>{t[tid] = sum.map(s=>s[2]).reduce((x,y)=>x+y)})\r\n        });\r\n\r\n        let res = [];\r\n        _.forOwn(o, (e, i)=> {\r\n            e.label = i;\r\n            res.push(e);\r\n        });\r\n        this.data = res.sort((a, b)=>{return (a.label>b.label)?1:((b.label>a.label)?-1:0)});\r\n        this.render();\r\n    }\r\n\r\n    formatValue(value) {\r\n        let decimalInfo = this.getDecimalsForValue(value);\r\n        let formatFunc = kbn.valueFormats[this.panel.format];\r\n        if (formatFunc) {\r\n            return formatFunc(value, decimalInfo.decimals, decimalInfo.scaledDecimals);\r\n        }\r\n        return value;\r\n    }\r\n\r\n    link(scope, elem, attrs, ctrl) {\r\n        class groupedBarChart {\r\n            constructor(opts) {\r\n                this.data = opts.data;\r\n                this.margin = opts.margin;\r\n                this.width = opts.width;\r\n                this.height = opts.height;\r\n                this.showLegend = opts.legend;\r\n                this.element = elem.find(opts.element)[0];\r\n                console.log(this.data);\r\n                this.options = d3.keys(this.data[0]).filter(function(key) { return key !== 'label'; });\r\n                this.avgList = {};\r\n                this.options.forEach(d=>{this.avgList[d] = 0});\r\n                this.options = this.options.filter(d=>d!=='valores');\r\n                this.data.forEach(d=> {\r\n                    d.valores = this.options.map(name=> {\r\n                        this.avgList[name] = this.avgList[name] + d[name];\r\n                        return {name: name, value: +d[name]};\r\n                    });\r\n                });\r\n                this.options.forEach(d=>{\r\n                    this.avgList[d] /= this.data.length;\r\n                });\r\n                this.draw();\r\n            }\r\n\r\n            draw() {\r\n                d3.select(this.element).html(\"\");\r\n                this.svg = d3.select(this.element).append('svg');\r\n                this.svg.attr('width', this.width)\r\n                    .attr('height', this.height)\r\n                    .attr('transform', `translate(0, ${this.margin.top})`);\r\n\r\n                this.createScales();\r\n                this.addAxes();\r\n                this.addTooltips();\r\n                this.addBar();\r\n                if(this.showLegend) this.addLegend();\r\n            }\r\n\r\n            createScales() {\r\n                this.y0 = d3.scale.ordinal()\r\n                    .rangeRoundBands([this.height, 0], .2, 0.5);\r\n\r\n                this.y1 = d3.scale.ordinal();\r\n\r\n                this.x = d3.scale.linear()\r\n                    .range([0, this.width]);\r\n\r\n                this.color = d3.scale.ordinal()\r\n                    .range(d3.scale.category20().range());\r\n            }\r\n\r\n            addAxes() {\r\n                this.xAxis = d3.svg.axis()\r\n                    .scale(this.x)\r\n                    .tickSize(-this.height)\r\n                    .orient('bottom');\r\n\r\n                this.yAxis = d3.svg.axis()\r\n                    .scale(this.y0)\r\n                    .orient('left');\r\n\r\n                this.y0.domain(this.data.map(d=> { return d.label; }));\r\n                this.y1.domain(this.options).rangeRoundBands([0, this.y0.rangeBand()]);\r\n                this.x.domain([0, d3.max(this.data, function(d) { return d3.max(d.valores, d=> { return d.value; }); })]);\r\n\r\n                this.svg.append('g')\r\n                    .attr('class', 'x axis')\r\n                    .attr('transform', `translate(${this.margin.left}, ${this.height})`)\r\n                    .call(this.xAxis);\r\n\r\n                this.svg.append('g')\r\n                    .attr('class', 'y axis')\r\n                    .attr('transform', `translate(${this.margin.left}, 0)`)\r\n                    .call(this.yAxis);\r\n            }\r\n\r\n            addBar() {\r\n                this.options.forEach(d=> {\r\n                    this.svg.append('line')\r\n                        .attr('x1', this.x(this.avgList[d]))\r\n                        .attr('y1', this.height)\r\n                        .attr('x2', this.x(this.avgList[d]))\r\n                        .attr('y2', 0)\r\n                        .attr('class', `${d} avgLine`)\r\n                        .attr('transform', `translate(${this.margin.left}, 0)`)\r\n                        .style('display', 'none')\r\n                        .style('stroke-width', 2)\r\n                        .style('stroke', this.color(d))\r\n                        .style('stroke-opacity', 0.7);\r\n                });\r\n\r\n                this.bar = this.svg.selectAll('.bar')\r\n                    .data(this.data)\r\n                    .enter().append('g')\r\n                    .attr('class', 'rect')\r\n                    .attr('transform', d=> {\r\n                        return `translate(${this.margin.left}, ${this.y0(d.label)})`;\r\n                    });\r\n\r\n                this.barC = this.bar.selectAll('rect')\r\n                    .data(d=> { return d.valores; })\r\n                    .enter();\r\n\r\n                this.barC.append('rect')\r\n                    .attr('height', this.y1.rangeBand())\r\n                    .attr('y', d=> { return this.y1(d.name);})\r\n                    .attr('x', d=> { return 0;})\r\n                    .attr('value', d=> { return d.name;})\r\n                    .attr('width', d=> { return this.x(d.value);})\r\n                    .style('fill', d=> { return this.color(d.name);});\r\n\r\n                this.barC.append('text')\r\n                    .attr('x', d=> { return this.x(d.value) +5;  })\r\n                    .attr('y', d=> { return this.y1(d.name) +(this.y1.rangeBand()/2); })\r\n                    .attr('dy', '.35em')\r\n                    .text(d=> { return d.value; });\r\n\r\n                this.bar.on('mouseover', d=> {\r\n                    this.tips.style('left', `${10}px`);\r\n                    this.tips.style('top', `${15}px`);\r\n                    this.tips.style('display', \"inline-block\");\r\n                    let elements = d3.selectAll(':hover')[0];\r\n                    let elementData = elements[elements.length-1].__data__;\r\n                    this.tips.html(`${d.label} , ${elementData.name} ,  ${elementData.value}`);\r\n                    d3.selectAll(`.${elementData.name}`)[0][0].style.display = '';\r\n                });\r\n\r\n                this.bar.on('mouseout', d=> {\r\n                    this.tips.style('display', \"none\");\r\n                    d3.selectAll('.avgLine')[0].forEach(d=> {\r\n                       d.style.display = 'none';\r\n                    });\r\n                });\r\n            }\r\n\r\n            addLegend() {\r\n                this.legend = this.svg.selectAll('.legend')\r\n                    .data(this.options.slice())\r\n                    .enter().append('g')\r\n                    .attr('class', 'legend')\r\n                    .attr('transform', (d, i)=> { return `translate(0,${i*20})`; });\r\n\r\n                this.legend.append('rect')\r\n                    .attr('x', this.width*1.1 - 18)\r\n                    .attr('width', 18)\r\n                    .attr('height', 18)\r\n                    .style('fill', this.color);\r\n\r\n                this.legend.append('text')\r\n                    .attr('x', this.width*1.1 - 24)\r\n                    .attr('y', 9)\r\n                    .attr('dy', '.35em')\r\n                    .style('text-anchor', 'end')\r\n                    .text(d=> { return d; });\r\n            }\r\n\r\n            addTooltips() {\r\n                this.tips = d3.select(this.element).append('div')\r\n                    .attr('class', 'toolTip');\r\n            }\r\n\r\n            setData(newData) {\r\n                this.data = newData;\r\n                this.draw();\r\n            }\r\n        }\r\n\r\n        function onRender() {\r\n            let sample = [\r\n                {label:\"Machine001\", \"Off\":20, \"Down\":10, \"Run\": 50, \"Idle\":20},\r\n                {label:\"Machine002\", \"Off\":15, \"Down\":30, \"Run\":40, \"Idle\":15}\r\n            ];\r\n\r\n            var Chart = new groupedBarChart({\r\n                data: ctrl.data,\r\n                margin: {top: 10, left: 80, bottom: 10, right: 10},\r\n                element: '#chart',\r\n                width: ctrl.panel.width,\r\n                height: ctrl.panel.height,\r\n                legend: ctrl.panel.legend.show\r\n            });\r\n        }\r\n\r\n        this.events.on('render', function() {\r\n            onRender();\r\n        });\r\n    }\r\n}\r\n\r\nGroupedBarChartCtrl.templateUrl = 'partials/module.html';"]}